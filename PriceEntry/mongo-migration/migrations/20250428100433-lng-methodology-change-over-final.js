module.exports = {
  async up(db, client) {
    console.log('Running migration 20250428100433-lng-methodology-change-over-final');
    const session = client.startSession();
    try {
      await session.withTransaction(async () => {
        const startDate = '2025-04-11T00:00:00.000+00:00';
        const endDate = '2025-05-12T00:00:00.000+00:00';

        const seriesIds = [
          '0247df95-dfcf-402c-974b-9e9a40cdefdd',
          '077a4586-fa88-4678-9a7a-e59e75d2d1ca',
          '07b18ba3-a7c1-4d4a-9cb6-a447e24102d1',
          '08e4e2c3-fad9-42d2-8998-623f45a9ea99',
          '0984da0d-6e1f-4ee0-966f-311b7c369947',
          '0c060f27-69b5-4ba9-99e6-4f98c54c7fc1',
          '0d1a7863-5eb4-4411-9f50-390ee8c48ffc',
          '11bf34f6-a663-4dae-a6f1-3e7e4205440c',
          '12ae0c2d-f630-491f-9b14-f296ee1de565',
          '12f2fb6b-65d8-41da-991d-c12d8499478a',
          '141fb72a-e3c8-41d2-b794-8673233a43de',
          '16df604b-629d-44d3-ab4a-a3e12dc5751c',
          '17ad3c06-ef4a-4bfe-881c-65b44c67bd9a',
          '18250860-79ec-4942-9bf0-898fd3e9b87f',
          '1cdbab5b-3a83-453b-b693-0793bc3bfd4a',
          '1d8f2da2-65b5-448d-b78b-df673545ef36',
          '1dd2fb3a-f710-43a5-860b-e0227760f7dc',
          '1f01ead4-1c9e-470c-9dc2-375899ab20e7',
          '200d8931-38bd-410c-8bbb-ad753f1ff391',
          '2021c394-97b1-4cc2-8e66-a8b69ce5e78d',
          '20bc9bbb-5faa-490d-ade5-e26d7ddffb20',
          '21821913-5c27-4998-a374-b2b44522f92a',
          '21a4a4bb-f5d8-4723-a46d-29f14390e175',
          '252639f0-8d22-45ad-bf3b-aa643f86c3a2',
          '272f3a73-b2e7-495e-9b5f-7b7af4926da5',
          '2879c715-4fd4-4463-bb95-5b5fcb373845',
          '2a7cb46b-be2c-4a55-be58-0503bbd66138',
          '2b2a8b01-90a6-4213-a2f1-fd8d0f3d59b4',
          '2bf285ab-196d-494d-8167-3124d15024f0',
          '2d111ea7-97bf-4d7a-9db8-5e58639ac631',
          '2e65742b-b5b1-4298-b364-0b4bc056fb68',
          '2e7cc518-7482-4671-ae96-7d6d771ad691',
          '2f2b180c-c69d-4cf4-b2f3-25b8a70dce64',
          '2f999ecb-5263-41e4-8fc5-3ab13c979f5d',
          '2fa849b1-49e5-45be-a5c1-b3008bd02f33',
          '2fde11bd-a8d7-4022-ade4-98479e7ced5b',
          '302030a9-b222-403c-864c-a0902dff5ec8',
          '3050e742-a488-4953-a293-4e2a4b53fcfd',
          '30cd7dc1-5d3c-453d-af7e-072e39161980',
          '31656d45-6d2d-4bd0-a601-479e00398d7b',
          '31c8e279-cf23-4589-89b7-a93375f09380',
          '33994aaa-eac5-4196-ac47-a76df25775a6',
          '33a38be0-14b2-4c01-ac1d-dda293245bfa',
          '3453a65e-886d-4a60-8e16-6c2557f3ad39',
          '349cac30-6554-418b-9498-1fb3290eecb7',
          '357a74be-a483-4f9b-9782-7050e10599e8',
          '35b529a9-39d1-4a09-87c1-ed13d01f8eb8',
          '35c2439b-76ab-40d8-b325-5bcdc4b65bc2',
          '37400962-8dbd-48f2-af31-895b9fdb4167',
          '379995c3-f4fa-432f-b2d1-d314b02a2fd4',
          '3b028966-1a8e-44cf-8a0d-34a124f5642c',
          '3bbc450d-3707-41f3-94d9-92a5f123309e',
          '3d496751-e093-4935-953b-07c776b43534',
          '3df49fcc-7a51-491c-b09b-93eacd5edafd',
          '3df642f2-7426-43dc-b347-86ce770043ca',
          '3eeb4344-004b-4cf3-9dd0-2a980c92f868',
          '4053b9b6-283c-4f7b-8b29-a1de5873bd5e',
          '40f0e901-c132-49cf-89f0-3e16af6379b5',
          '437b6115-a0ab-4306-8ad6-6265b66dfa39',
          '46180bda-a59c-4131-9399-c896ff1a7f69',
          '46cb6c43-abd6-4e4b-ae91-ed5864586f49',
          '47f63978-011f-4396-b291-b277326c6d58',
          '4829ebc3-fc24-48c2-8405-2eec460669fa',
          '485fe562-4c6d-47d9-badc-fdf0f046e4b6',
          '4ba9b510-89d0-4b04-8f6a-e8ec45b7576d',
          '4f07a97f-0095-46d8-9386-709efc8245d4',
          '4fb5eca3-428f-481d-b49b-b7d12341d97d',
          '51017959-17bf-4c14-9ebf-01e70a343681',
          '543004b5-e3ec-47d5-9a5a-4608999e568e',
          '54d473f0-2cac-4fec-a7c0-c23be0abdea7',
          '56d7144b-6995-439e-8732-804f09b6eeda',
          '57f846fd-97bf-47b4-9ec3-b2a91884c5f0',
          '585d8d44-8693-46ae-86b8-dbf4cb193a50',
          '5ae7ec2c-a9d5-45a1-bc9e-1952b1e46463',
          '5c10ac9f-2b59-4939-8912-8b1fc4bdd171',
          '5c47e413-d570-4540-ae6d-736b3e8e8169',
          '5d174c57-c843-492d-b692-357a04018331',
          '5d71475a-ed00-4539-83cf-c3003e3b575b',
          '5e58528e-3197-4c09-b6a2-2d8df8ea8da7',
          '600c0eb4-ac37-4779-b528-1c3db0f8a785',
          '61989a76-f533-42f3-a3c8-4cc30eb719b6',
          '61a8ab41-9dfc-4e82-867c-ad9a0456cb27',
          '62c68b72-0bda-4736-b37b-0c2d0c2f85e1',
          '63055c50-b5d3-43d5-a6f7-c8be5b247a04',
          '6323447e-d6a7-4968-b4e4-6a39c55f34e6',
          '650176ff-61dd-430c-ae44-9450322ebd2a',
          '65bb8abf-5498-47c9-ab8a-4dbee14e804d',
          '65f3eb58-cea3-4d12-9d21-776a2137f4fc',
          '66f54970-86b2-48dc-80ed-87e609cbf9e0',
          '678c076d-d3be-491b-8ed4-7869155aabcb',
          '68918029-a8db-442f-bf8c-ae20649594ad',
          '6cffc3cd-d321-4be7-a2d5-77e190c22cff',
          '6daeb1bc-5173-4e7d-b3fc-97bcce703ba6',
          '6ee6ac9c-e836-4e30-b9cc-c5ae04416b0c',
          '6f37247a-ef9e-4ed4-9b55-d5de96316f1f',
          '72fb8e02-2315-471b-9dd9-93640423b806',
          '7347aef5-a0ea-4ef6-a4f1-8b7cb44c6a16',
          '7352bfe6-6059-49e5-ab70-431070f6eb94',
          '7355433e-c030-4986-b4f8-5468f1b5ef9a',
          '74a75211-8adb-4136-88cd-4dc4210dbb1a',
          '751619c5-4f88-483c-a71c-320c9d986c66',
          '76b54907-2a0e-4aef-ba92-7382c107a175',
          '77207eb2-bd03-470e-b5cb-359b187f8f4f',
          '77d6854a-23de-4e62-b657-35c9765bc55b',
          '785452af-d8ca-4c0a-9055-3e607ae0c8bb',
          '78b6273f-b398-4568-ada5-7e40c5656bf7',
          '78f2865e-8388-4ade-9bca-410c52aa6eb1',
          '7aa9557d-aa00-4c2f-8586-d45ffbf98e68',
          '7aec388a-b7fe-4238-bffa-27852057dce9',
          '7b0226da-9efc-4b68-a029-caa98764a1cb',
          '7cfc9f08-500f-493c-a90e-70398d58dcc7',
          '7e2092dd-9f73-4842-af39-346aa128c63a',
          '7ecf8404-0213-4a4e-98d5-d2ce4bf8190f',
          '7f92bb0a-be61-4e11-a977-812f72496d08',
          '7ff1c1fb-13e2-4422-8011-99bfae17cb69',
          '81c88ca2-b20f-4c25-9362-f9164968bd45',
          '825f3d6f-7c07-4597-aba3-a205b455a0aa',
          '82c794b2-26ea-4068-8370-421c33891756',
          '84c5e2ce-1eea-473c-a8f8-e1a38f55dbf5',
          '857115ad-1920-46ee-8784-563209dfa42e',
          '8774e760-5512-47d2-ae73-8bae22a8daf0',
          '89b20089-2ca5-4c2b-8446-f82fbe45f68b',
          '8c23ad15-8664-444b-b213-898383d17691',
          '8c261c03-d079-4aad-91c7-9525da6b88ce',
          '8c66eff6-1df3-4cc4-945e-74ccaa3d9d43',
          '8c90c9dd-dae6-45d5-8ca1-a2489e5a2703',
          '8cbe1524-d810-44b4-b7fe-6650884f0b74',
          '8cedbaaf-1e29-434c-be1b-be2aaee781b9',
          '8cef4d5f-8ac5-438a-8fd4-f7df1770e675',
          '8d3f72fa-4621-4a9a-9dce-bde862cb8ca1',
          '8ef1cb15-e181-4005-a255-e59c86604108',
          '8f7b58f7-d625-4a76-a432-493db82174ee',
          '90dce959-898f-4059-a436-a4bf13be4bf8',
          '90f821b0-a396-4578-a233-f0141eca786b',
          '91c5dd14-9ff7-4c40-a2be-5f32e61e1744',
          '91fce5c4-f068-4f6d-a778-08792b86d8c7',
          '9221450d-69a4-45b9-81e9-90fb33d989f3',
          '93b603cc-1eb3-47a0-bc2a-6d5ade3a2d8b',
          '93fc51c3-cf09-4a0f-8192-e95d763c5c8d',
          '9590ef63-5d31-4d3b-afe6-2223c75a14d4',
          '95d41fb5-572d-4d9d-8d57-b18633be69e7',
          '96b4d3cb-56e8-4dd2-94b9-826b79322ed6',
          '96da838d-80e3-4a28-a8cc-1010ad424a93',
          '977c981d-2cb5-4996-b063-7e48d680176d',
          '9956fa1f-0540-4b31-b1d2-7f52610b6fae',
          '9981e4e0-3ad6-4e79-ba71-2a6ef1e23498',
          '9ae93cb0-ddeb-4e93-8aff-916644f90c4c',
          '9b10c254-a314-40b2-b396-b910d6c61c07',
          '9b1b5584-12c3-4c96-b8a9-bd28391c7a64',
          '9b22c4e3-b755-49ea-b8d0-7ca32a5d594c',
          '9bb564ee-888e-4228-9274-8b981e3b5d19',
          '9d27a847-5d70-4fa8-82b1-45f2c9871ec4',
          '9fbaa581-04e2-4a4a-b384-dc26244aa9f6',
          'a1696192-57a0-4df3-bf23-09e4ece883ef',
          'a1d5a2ce-fa29-4630-bd76-837379ac9c3a',
          'a2944b38-7735-436e-b064-567faa47525a',
          'a31eff81-1af0-4681-b4d1-512cc69fd825',
          'a3f06f3d-10da-422b-af0a-42ee55127df1',
          'a3fd0488-192d-4e4d-9166-028f4dc7ca6b',
          'a583178f-3656-429c-a20f-6e8334d2a6c0',
          'a735d38a-0887-47ad-80f9-fb8b70b06b30',
          'a7aa4f37-cd9c-4914-a0a1-2a27508c430c',
          'a8ce20aa-ede9-4253-af2c-334e40a59a0e',
          'a9450311-8045-428a-a4a4-2ab5d4b24b13',
          'aa830e51-b952-4cca-b76c-c69a72f28bbc',
          'ac4a7d1e-6cec-4af2-a388-9dba0036432c',
          'ac84bba9-1611-4340-99be-cc50a88ba5ed',
          'ad6c8624-8d8c-4e7d-a221-7617905e3fc0',
          'add5980a-bf63-41be-b82a-f9f181dfda3f',
          'ae04d0d0-d8e1-4864-b005-f46e5605274c',
          'ae1fd659-dcda-419b-a8ec-8cc957aefe7d',
          'ae5b7ec1-7c34-4eac-958f-46a51d135e13',
          'b116d81a-5aca-49c9-a0bb-7caa4f6fca00',
          'b12462f0-d8c6-456d-9010-4c3e68e0e289',
          'b2e79848-3c96-405e-9c8a-2d9bff7d25eb',
          'b3106302-8a7e-4077-9bd4-d7d4314e9682',
          'b3b1acae-a7de-490b-a30e-ea95848da178',
          'b5a86abc-3afe-4e02-ad9e-5c08c169d239',
          'b7605732-19d7-4b43-b8b9-ffde182b7686',
          'b7876e37-b008-4883-82cc-99163b0466dd',
          'b8c53024-0f2b-479d-a72d-7e9c63bd88f5',
          'b9f25764-0472-41cf-ac20-c72c91c19b76',
          'ba36e4d4-cdd2-4bbc-a2ee-81bc02fee8f9',
          'badc8e04-bf47-4a6d-b36f-15f2b8b56269',
          'bc80987e-d0e2-4019-a7a7-6dfe0d8de103',
          'bcc8cb9c-e7cb-4539-95a3-f4b2eb17385e',
          'bd44503d-3adc-4d20-a9b4-725c622b48d9',
          'bddf91f8-c48a-476b-b8e4-47cce73ce06a',
          'be1496d4-64d6-459d-95db-286f1f1d5194',
          'c265ebab-39e4-4514-ba84-cb20509cb196',
          'c2a08cb5-4e86-4676-b2a2-5d8f9f5e3eee',
          'c44e7661-5225-420f-a4b1-ad181ba60cef',
          'c552e4ec-a838-479d-9e03-ceb0f017bf51',
          'c58a32b7-d4ea-4cb7-b037-9391dc8a9791',
          'c59bd884-7f4e-4f9d-846e-c078fd5569c8',
          'c7391cef-b1c4-4518-9dc4-5c382bc6597c',
          'c7d1c38b-eba1-4f71-a9f8-859cd8413839',
          'c98ad08f-028a-4b5c-8815-49071e6f327b',
          'cd4722a8-e96b-48ba-88b8-a9129d59ccc0',
          'cf552fb6-d8f7-4b89-89e3-3e8de02d8425',
          'cf5716ea-7cb6-4c99-8368-1bf5ee5c4255',
          'cffd04f4-f947-45b9-b2bf-ed223bc59d37',
          'd05cfdae-0b35-4c67-a5d6-64c43759356f',
          'd06e8232-cd60-48b6-8972-91d40fc5a6d5',
          'd1c9ee12-2074-46d6-b67e-04d6da52a2a0',
          'd20db60a-d39b-4884-8ac5-990e7631841e',
          'd2eb79c5-7077-4a59-a059-8df07e9b854a',
          'd3aedf67-036b-4267-bf28-cca59f9880f4',
          'd4252807-204f-4ba0-9c92-87c657ef1a7f',
          'd4750e0f-6fcb-41ba-87fd-902d1d2109dc',
          'd6361473-10f9-480b-99f7-bf17008efd4e',
          'd70b08fc-ca69-42ec-87f1-508a0d3d5a21',
          'd971690f-398d-4f50-a85e-46c5a462204a',
          'd99bbc12-233b-471f-bddf-bba8510e2cae',
          'da3c680f-599c-4afa-b641-b135904ed7fb',
          'db6fdc26-1e48-4804-b809-ad1ea4b558c1',
          'dbd72a99-93e3-467f-9ad4-165bff84f0dd',
          'dcb54e5b-9278-4b30-9e3c-3432c0169368',
          'dfe2d848-80f2-4d81-b3c1-1e9ee533dd3e',
          'e068c499-984d-433b-bdbb-753f7a5e682c',
          'e09941a6-ad57-43f5-ab4f-158b5b8b3e5a',
          'e09cd6fe-446c-49a1-a8f5-59254a011b07',
          'e0c590f3-ffc8-4ab1-8fc3-b963e2c0bd2d',
          'e477d836-26e4-43ba-9552-fb56c9f96016',
          'e47eee9a-4cd7-4048-bcbc-229e3236021c',
          'e58733f7-7456-4d5c-a0ea-cf14e8ff4c1d',
          'e5be513d-92a9-4be6-9ab5-2e482e303b6b',
          'e656b2c2-12c0-4993-8e1b-7c3863fbafe1',
          'eac7ce5f-14f6-480b-900f-0b120cde50ef',
          'ec83b252-e315-404a-a563-4deb690d595c',
          'eca2b60b-f4e9-4cb6-b03b-1c9193dde18d',
          'efa42ff3-51cb-4d8a-abd4-a12b26b7d7b8',
          'f0659fd7-ce4f-4720-9520-08f2c2aadfd8',
          'f0a3a721-312b-4cd0-87e8-23d6b55dfcc5',
          'f166184f-410b-4810-af22-5c4249531c82',
          'f1af84a2-8168-40d7-b00c-c59acdcb1518',
          'f1e32fb3-147d-4a36-aaa9-eb8cf4c6d158',
          'f1f6895f-1608-4443-984d-91dee754beb4',
          'f376ee2d-8558-4ab0-b8b8-a6e2f39604da',
          'f4c3eabb-42af-4cd4-a67c-aef06305c70a',
          'f54ea36f-f431-4a85-ac95-9cd169a7ffdb',
          'f64b57a6-b21c-4992-b9ed-a3d8847b16b4',
          'f78a5b3a-bfa4-497e-bf37-86dfd23ce2c9',
          'f94bc22f-70f2-4a60-8592-e8fe4f102dcf',
          'f9de8664-1a4f-4c3b-bf90-98b05cd86dca',
          'fa387df4-1472-4203-b7c7-02c4882cac65',
          'faa2615d-1ebc-482c-a441-41bedb800639',
          'fab41c26-a31e-48d8-ad94-f245cc01908a',
          'fb01b348-c321-458d-acbe-bd7cab7d9aa4',
          'fb3a4f66-cd98-40fe-ac5a-2e6eb23cb374',
          'fb3a5673-ede8-4d26-bfe7-98ea39fde722',
          'fbfbdf21-99c2-42a9-90ec-3134b04e2014',
          'fc295ffb-c03d-41ca-b831-0bfc135735fa',
          'fd119b6e-15ff-446d-bc5c-e526314e1a4e',
          '2b70b8fd-db4c-4f41-a489-549f7830a93a',
          '98ce75b5-aa2b-4155-93bd-cdac7807c4b3',
          'c2868e23-00e8-4246-a7ed-9b3e217c52dd',
          '4873b1b6-9d71-46f1-b756-da18e2bc1556',
          '91d4d746-99ef-4aae-a101-cc96b1bfa4c3',
          'efe45753-fd7d-4eea-af4a-c284e01d97db',
          'bddc314e-f78e-4ead-8c94-b27cb095dc1a',
          'cb4ddfa2-46f2-47b6-b3fc-bc5587161b28',
          '23f618b2-3bb7-4c9d-9e87-389b8bfe6929',
          'f24ee00e-9662-428d-b93d-7e4b228aae1b',
          'a4e6564d-bd37-49c3-a9c6-25ab8e5a841c',
          '5e6c69d7-e592-453f-b103-6dc58d31bd70',
        ];

        // Find all content block that belong to the series
        const contentBlocksAggregationResult = await db.collection('content_block_definitions').find({
          'price_series_grids.price_series_ids': { $in: seriesIds },
        }, { session }).toArray();

        const contentBlockIds = contentBlocksAggregationResult.map((doc) => doc.content_block_id);

        // Find all series items that belong to the series
        const seriesItemsAggregationResult = await db.collection('price_series_items').find({
          series_id: { $in: seriesIds },
          applies_from_datetime: { $gte: new Date(startDate), $lte: new Date(endDate) },
          $or: [
            { dlh_record_source: 'dp-analytics-platform-prod' },
            { dlh_record_source: null },
            { dlh_record_source: 'lng-arbitrage-prod' },
          ],
        }, { session }).toArray();

        const seriesItemIds = seriesItemsAggregationResult.map((doc) => doc._id);

        // Find all content packages that have the series items
        const contentPackagesAggregationResult = await db.collection('content_packages').find({
          'price_series_item_groups.price_series_item_ids': { $in: seriesItemIds },
        }, { session }).toArray();

        const contentPackageIds = contentPackagesAggregationResult.map((doc) => doc._id);

        // Delete all price_series_items, content_packages and pricing_content_packages
        // & commentaries

        await db.collection('price_series_items').deleteMany({
          _id: { $in: seriesItemIds },
        }, { session });

        await db.collection('content_packages').deleteMany({
          _id: { $in: contentPackageIds },
        }, { session });

        await db.collection('pricing_content_packages').deleteMany({
          _id: { $in: contentPackageIds },
        }, { session });

        await db.collection('commentaries').deleteMany({
          content_block_id: { $in: contentBlockIds },
          applies_from_datetime: { $gte: new Date(startDate), $lte: new Date(endDate) },
        }, { session });
      });
    } finally {
      await session.endSession();
    }
  },

  async down(db, client) {
    throw new Error('Rollback unsupported');
  },
};
