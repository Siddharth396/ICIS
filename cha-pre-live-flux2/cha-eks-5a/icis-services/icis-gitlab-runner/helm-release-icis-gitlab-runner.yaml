---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gitlab-runner
  namespace: icis-gitlab-runner
spec:
  releaseName: gitlab-runner
  interval: 5m0s
  chart:
    spec:
      chart: gitlab-runner
      version: "0.47.0"
      sourceRef:
        kind: HelmRepository
        name: gitlab-runner
        namespace: icis-gitlab-runner
  upgrade:
    remediation:
      remediateLastFailure: true
      strategy: rollback

  values:
    imagePullPolicy: IfNotPresent
    gitlabUrl: https://gitlab.cha.rbxd.ds/
    runnerRegistrationToken: "PqsHGTe6Gmqnu4zZq4Yp"
    unregisterRunners: true
    terminationGracePeriodSeconds: 3600
    certsSecretName: gitlab-internal-cas

    envVars:
      - name: CI_SERVER_TLS_CA_FILE
        value: /home/gitlab-runner/.gitlab-runner/certs/b2b.crt

    concurrent: 20
    checkInterval: 1
    logLevel: info
    logFormat: json

    rbac:
      create: true
      clusterWideAccess: true
      podSecurityPolicy:
        enabled: false
        resourceNames:
        - gitlab-runner

    metrics:
      enabled: true
    runners:
      executor: kubernetes
      tags: "k8s-cha-eks-b"
      namespace: icis-gitlab-runner
      imagePullSecrets: [nexus-image-pull-secret]
      cache: {}
      builds: {}
      services: {}
      helpers: {}

      config: |
        [[runners]]
          [runners.kubernetes]
            namespace = "icis-gitlab-runner"
            namespace_overwrite_allowed = ""
            service_account = "gitlab-runner"
            service_account_overwrite_allowed = ".*"

            privileged = true

            image = "alpine:3"
            pull_policy = "always"
            
            output_limit = 10485760 # Increased log limit to 10mb

    podSecurityContext:
      runAsUser: 100
      fsGroup: 65533

    resources: 
      limits:
        memory: 256Mi
        cpu: 200m
      requests:
        memory: 128Mi
        cpu: 100m
