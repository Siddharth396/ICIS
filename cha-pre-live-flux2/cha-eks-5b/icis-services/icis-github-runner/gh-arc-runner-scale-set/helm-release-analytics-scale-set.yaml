---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: icis-github-arc-runner-analytics-scale-set
  namespace: icis-gh-arc-runners
spec:
  releaseName: icis-github-arc-runner-analytics-scale-set
  interval: 5m0s
  chart:
    spec:
      chart: gha-runner-scale-set
      version: "0.9.3"
      sourceRef:
        kind: HelmRepository
        name: helm-charts
        namespace: flux-system
  upgrade:
    remediation:
      remediateLastFailure: true
      strategy: rollback

  values:
    ## githubConfigUrl is the GitHub url for where you want to configure runners
    githubConfigUrl: "https://github.com/LexisNexis-RBA" #Organization

    githubConfigSecret: gh-config-sec-org-sre-eks

    maxRunners: 10
 
    minRunners: 1

    runnerGroup: "dsg-icis-eks-github-actions-runner"

    ## name of the runner scale set to create.  Defaults to the helm release name
    runnerScaleSetName: "gha-cha-eks-analytics-5b"

    template:
      spec:
        initContainers:
        - name: init-dind-externals
          image: artifacts.cha.rbxd.ds/github-actions-runner/gh-runner:2.327.1
          command: ["cp", "-r", "-v", "/home/runner/externals/.", "/home/runner/tmpDir/"]
          volumeMounts:
            - name: dind-externals
              mountPath: /home/runner/tmpDir
          securityContext:
            runAsUser: 1001
            runAsGroup: 123
            allowPrivilegeEscalation: true  
            privileged: true
        containers:
        - name: runner
          image: artifacts.cha.rbxd.ds/github-actions-runner/gh-runner:2.327.1 
          command: ["/home/runner/run.sh"]
          env:
            - name: DOCKER_HOST
              value: unix:///var/run/docker.sock
            - name: NODE_EXTRA_CA_CERTS
              value: /etc/ssl/certs/ca-certificates.crt
          volumeMounts:
            - name: work
              mountPath: /home/runner/_work
            - name: dind-sock
              mountPath: /var/run
        - name: dind
          image: artifacts.cha.rbxd.ds/github-actions-runner/dind/docker:dind-4.0.0
          args:
            - dockerd
            - --host=unix:///var/run/docker.sock
            - --group=$(DOCKER_GROUP_GID)
          env:
            - name: DOCKER_GROUP_GID
              value: "123"
          securityContext:
            privileged: true
          volumeMounts:
            - name: work
              mountPath: /home/runner/_work
            - name: dind-sock
              mountPath: /var/run
            - name: dind-externals
              mountPath: /home/runner/externals
        volumes:
          - name: work
            emptyDir: {}
          - name: dind-sock
            emptyDir: {}
          - name: dind-externals
            emptyDir: {}        


    podSecurityContext:
      runAsUser: 100
      fsGroup: 65533

    resources: 
      limits:
        memory: 1000Mi
        cpu: 800m
      requests:
        memory: 500Mi
        cpu: 500m
 
