---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: authoring-bff
spec:
  values:
    replicaCount: 1
    projectName: "authoring-chempf"
    ServiceAccountName: "chempf"
    vault_secrets:
      VaultK8sRoleName: "kv-chempf-read"
      VaultK8sAuthPath: "cha/eks-b"
      VaultSecretMount: "kv/cha/k8s"
    vault_secrets_proxy:
      VaultK8sRoleName: "kv-chempf-read"
      VaultK8sAuthPath: "cha/eks-b"
      VaultSecretMount: "kv/cha/k8s"
      VaultSecretPath: "authoring-auth-proxy/mongo"

    nginx:
      port: 443
      image:
        repository: artifacts.cha.rbxd.ds/base-image/nginx
        tag: alpine3.17
        pullPolicy: IfNotPresent
      resources:
        requests:
          memory: "64Mi"
          cpu: "100m"
        limits:
          memory: "128Mi"
          cpu: "100m"
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 443
          scheme: HTTPS
        initialDelaySeconds: 30
        periodSeconds: 5
        timeoutSeconds: 2
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 443
          scheme: HTTPS
        periodSeconds: 30
      config: |-
        map $http_upgrade $connection_upgrade{
            default upgrade;
            '' close;
        }
        server {
          listen 443 ssl;
          server_name  localhost;

          proxy_read_timeout 300;
          proxy_connect_timeout 300;
          proxy_send_timeout 300;

          access_log /dev/stdout main;
          error_log /dev/stdout warn;

          ssl_certificate /etc/ssl/tls.crt;
          ssl_certificate_key /etc/ssl/tls.key;

          client_header_buffer_size    8k;
          large_client_header_buffers  4 32k;

          server_tokens off;
          
          #Reverse Proxy rules to serve the BFF from other container
          
          location ~* ^/internal/metrics {
            deny all;
            return 403;
            server_tokens off;
          }
          location / {
                  proxy_pass http://localhost:8501/;
                  proxy_set_header        Host $host;
                  proxy_set_header        X-Real-IP $remote_addr;
                  proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header        X-Forwarded-Proto $scheme;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
          }
          location /_stcore/stream {
                  proxy_pass http://localhost:8501/_stcore/stream;
                  proxy_http_version 1.1;
                  proxy_redirect http:// $scheme://;
                  proxy_set_header Host $http_host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_read_timeout 86400;
          }
        }
