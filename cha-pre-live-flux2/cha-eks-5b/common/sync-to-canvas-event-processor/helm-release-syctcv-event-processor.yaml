apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: syctcv-event-processor
spec:
  interval: 5m0s
  chart:
    spec:
      chart: syctcv-event-processor
      version: "0.0.10"
      sourceRef:
        kind: HelmRepository
        name: helm-charts
        namespace: flux-system
  upgrade:
    remediation:
      remediateLastFailure: true
      strategy: rollback
  values:
    replicaCount: 1
    ServiceAccountName: "syctcv"
    projectName: "sync-to-canvas"
    vault_secrets:
      VaultK8sRoleName: "kv-syctcv-read"
      VaultK8sAuthPath: "cha/eks-b"
      VaultSecretMount: "kv/cha/k8s"
    vault_secrets_proxy:
      VaultK8sRoleName: "kv-syctcv-read"
      VaultK8sAuthPath: "cha/eks-b"
      VaultSecretMount: "kv/cha/k8s"
      VaultSecretPath: "authoring-auth-proxy/mongo"
    event_processor:
      resources:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "250m"
      config_env:
        Serilog__Source: "SyncToCanvas"
        Serilog__Component: "NotificationEventProcessor.EventProcessor"
        Serilog__Service: "SyncToCanvas.NotificationEventProcessor.EventProcessor"
        ELASTIC_APM_SERVICE_NAME: "SyncToCanvas - Event Processor"
        ELASTIC_APM_TRANSACTION_IGNORE_URLS: /internal/*
        ELASTIC_APM_CENTRAL_CONFIG: false
        ELASTIC_APM_ENABLED: true
        ELASTIC_APM_SERVER_URLS: https://apm.genesis.cha.eu-west-1.dev/
        DOMAIN_IDENTITY_CLIENT_ID: "sync-to-canvas-event-processor"
        DOMAIN_IDENTITY_URL: "https://domainidentity.integration.cha.rbxd.ds"
        SWAGGER_OAUTH_TOKEN_URL: "https://domainidentity.integration.cha.rbxd.ds/connect/token"
        SWAGGER_OAUTH_AUTHORIZATION_URL: "https://domainidentity.integration.cha.rbxd.ds/connect/authorize"
        IDDN_API_URL: "http://core.uat.iddn.cha.rbxd.ds:9000"
        SWAGGER_ENABLED: true
      port: 80
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 80
        periodSeconds: 30
    yjs_messaging_api:
      image:
        repository: artifacts.cha.rbxd.ds/automated/syctcv/yjs-message-api # {"$imagepolicy": "flux-system:syctcv-yjs-message-api-stable:name"}
        tag: stable-21-9.0.7-23490 # {"$imagepolicy": "flux-system:syctcv-yjs-message-api-stable:tag"}
        pullPolicy: IfNotPresent
    authproxy:
      env:
        Proxy__ExcludedPathsFromAuthorization: "(/v1(\\.[0-9])?/(version|jsnlog\\.logger))|(/swagger?/*)|health"
      port: 8090
      image:
        repository: artifacts.cha.rbxd.ds/automated/sbcore/sbcore-auth-proxy # {"$imagepolicy": "flux-system:sbcore-auth-proxy-stable:name"}
        tag: stable-108-1.4.95.1215 # {"$imagepolicy": "flux-system:sbcore-auth-proxy-stable:tag"}
        pullPolicy: IfNotPresent
      resources:
        requests:
          memory: "64Mi"
          cpu: "50m"
        limits:
          memory: "128Mi"
          cpu: "200m"
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 8090
        initialDelaySeconds: 30
        periodSeconds: 5
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 8090
        periodSeconds: 30
    serviceMonitor:
      enabled: true
      endpoints:
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 80
          scheme: http
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 8090
          scheme: http
