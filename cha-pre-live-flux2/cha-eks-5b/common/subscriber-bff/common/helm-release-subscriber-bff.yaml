apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: subscriber-bff
spec:
  interval: 5m0s
  chart:
    spec:
      chart: subscriber-bff
      version: 0.1.72
      sourceRef:
        kind: HelmRepository
        name: helm-charts
        namespace: flux-system
  upgrade:
    remediation:
      remediateLastFailure: true
      strategy: rollback
  values:
    replicaCount: 1
    autoscaling:
      enabled: false
      minReplicas: 1
      maxReplicas: 6
      targetCPUUtilizationPercentage: 80
      targetMemoryUtilizationPercentage: 80
    pdb:
      minAvailable: 1
    vault_agent:
      repository: "artifacts.cha.rbxd.ds/base-image/vault"
      tag: "latest"
    consul_template:
      repository: "artifacts.cha.rbxd.ds/base-image/consul-template"
      tag: "alpine"
    authproxy:
      #Add env variables for authproxy if needed
      #env:
      port: 8090
      image:
        repository: artifacts.cha.rbxd.ds/automated/sbcore/sbcore-auth-proxy # {"$imagepolicy": "flux-system:sbcore-auth-proxy-stable:name"}
        tag: stable-108-1.4.95.1215 # {"$imagepolicy": "flux-system:sbcore-auth-proxy-stable:tag"}
        pullPolicy: IfNotPresent
      resources:
        requests:
          memory: "64Mi"
          cpu: "50m"
        limits:
          memory: "128Mi"
          cpu: "200m"
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 8090
        initialDelaySeconds: 30
        periodSeconds: 5
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 8090
        periodSeconds: 30
    bff:
      resources:
        requests:
          memory: "128Mi"
          cpu: "50m"
        limits:
          memory: "256Mi"
          cpu: "200m"
      config_env:
        ELASTIC_APM_TRANSACTION_IGNORE_URLS: /internal/*
        ELASTIC_APM_SERVER_URLS: https://apm.genesis.cha.eu-west-1.dev/
      port: 80
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 80
        periodSeconds: 30
    nginx:
      port: 443
      image:
        repository: artifacts.cha.rbxd.ds/base-image/nginx
        tag: alpine3.17
        pullPolicy: IfNotPresent
      resources:
        requests:
          memory: "64Mi"
          cpu: "50m"
        limits:
          memory: "128Mi"
          cpu: "100m"
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 443
          scheme: HTTPS
        initialDelaySeconds: 30
        periodSeconds: 5
        timeoutSeconds: 2
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 443
          scheme: HTTPS
        periodSeconds: 30
      config: "server {\n  listen 443 ssl;\n  server_name  localhost;\n\n  proxy_read_timeout 300;\n  proxy_connect_timeout 300;\n  proxy_send_timeout 300;\n\n  access_log /dev/stdout main;\n  error_log /dev/stdout warn;\n\n  ssl_certificate /etc/ssl/tls.crt;\n  ssl_certificate_key /etc/ssl/tls.key;\n\n  client_header_buffer_size    8k;\n  large_client_header_buffers  4 32k;\n\n  server_tokens off;\n  \n  #Reverse Proxy rules to serve the BFF from other container\n  \n  location ~* ^/internal/metrics {\n    deny all;\n    return 403;\n    server_tokens off;\n  }\n  \n  location / {\n    add_header Strict-Transport-Security \"max-age=31536000\";\n    proxy_set_header Host $http_host;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n\n    proxy_buffers 4 64k;\n    proxy_buffer_size 32k; \n    proxy_busy_buffers_size 64k;\n\n    proxy_pass http://localhost:8090;\n  }\n}"
    serviceMonitor:
      enabled: true
      endpoints:
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 80
          scheme: http
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 8090
          scheme: http
    service:
      port_name: https
      port: 443
    vault:
      url: "https://vault_eu_prod.b2b.regn.net"
      VaultSecretPath: ""
      SecretPathProxy: "kv/cha/k8s/data/subscriber-auth-proxy/mongo"
      VaultK8sRoleName: ""
      VaultK8sAuthPath: "auth/cha/eks-b"
