---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: homepage-app

spec:
  values:
    ServiceAccountName: "atcore"
    environment_isAuthor: true
    vault_secrets:
      name: "homepage-app-vault-secret-atcore"
      VaultK8sRoleName: "kv-atcore-read"
      VaultK8sAuthPath: "cha/eks-b"
      VaultSecretMount: "kv/cha/k8s"
      VaultSecretPath: "authoring-auth-proxy/mongo"

    nginx:
      config: |-
        server {
          listen 443 ssl;
          server_name  localhost;

          access_log /dev/stdout main;
          error_log /dev/stdout warn;

          ssl_certificate /etc/ssl/tls.crt;
          ssl_certificate_key /etc/ssl/tls.key;

          client_header_buffer_size    8k;
          large_client_header_buffers  4 32k;
        
          server_tokens off;
          
          #Reverse Proxy rules to serve the BFF from other container
          
          location ~* ^/internal/metrics {
            deny all;
            return 403;
            server_tokens off;
          }
          
          location / {
            add_header Strict-Transport-Security "max-age=31536000";
            add_header X-Frame-Options "SAMEORIGIN";
            add_header X-XSS-Protection "1; mode=block";
            add_header X-Content-Type-Options "nosniff";
            add_header Content-Security-Policy "frame-ancestors 'self' *.cha.rbxd.ds; ";
            # add_header Content-Security-Policy-Report-Only "default-src 'self'; style-src 'unsafe-inline'; script-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'self'; form-action 'self'; ";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_buffers 4 64k;
            proxy_buffer_size 32k; 
            proxy_busy_buffers_size 64k;

            proxy_pass http://localhost:8090;
          }
        }
