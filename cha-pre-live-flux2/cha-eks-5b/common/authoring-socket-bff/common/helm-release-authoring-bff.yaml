apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: authoring-socket-bff
spec:
  interval: 5m0s
  chart:
    spec:
      chart: subscriber-bff
      version: "0.1.72"
      sourceRef:
        kind: HelmRepository
        name: helm-charts
        namespace: flux-system
  upgrade:
    remediation:
      remediateLastFailure: true
      strategy: rollback
  values:
    replicaCount: 1
    environment_isAuthor: true
    vault_agent:
      repository: "artifacts.cha.rbxd.ds/base-image/vault"
      tag: "latest"
    consul_template:
      repository: "artifacts.cha.rbxd.ds/base-image/consul-template"
      tag: "alpine"
    authproxy:
      #Add env variables for authproxy if needed
      #env:
      port: 8090
      image:
        repository: artifacts.cha.rbxd.ds/automated/atcore/atcore-auth-proxy # {"$imagepolicy": "atcore-auth-proxy-stable:name"}
        tag: stable-56-1.2.19 # {"$imagepolicy": "flux-system:atcore-auth-proxy-stable:tag"}
        pullPolicy: IfNotPresent
      resources:
        requests:
          memory: "64Mi"
          cpu: "10m"
        limits:
          memory: "128Mi"
          cpu: "100m"
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 8090
        initialDelaySeconds: 30
        periodSeconds: 5
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 8090
        periodSeconds: 30
    bff:
      resources:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "1"
      config_env:
        ELASTIC_APM_TRANSACTION_IGNORE_URLS: /internal/*
        ELASTIC_APM_SERVER_URLS: https://apm.genesis.cha.eu-west-1.dev/
      port: 80
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 80
        periodSeconds: 30
    nginx:
      port: 443
      image:
        repository: artifacts.cha.rbxd.ds/base-image/nginx
        tag: alpine
        pullPolicy: IfNotPresent
      resources:
        requests:
          memory: "64Mi"
          cpu: "100m"
        limits:
          memory: "128Mi"
          cpu: "100m"
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 443
          scheme: HTTPS
        initialDelaySeconds: 30
        periodSeconds: 5
        timeoutSeconds: 2
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 443
          scheme: HTTPS
        periodSeconds: 30
      config: |-
        map $http_upgrade $connection_upgrade{
            default upgrade;
            `` close;
        }
        upstream websocket{
            server localhost:80; 
            #SERVER endpoint that handle ws:// connections
        }
        server {
          listen 443 ssl;
          server_name  localhost;

          proxy_read_timeout 300;
          proxy_connect_timeout 300;
          proxy_send_timeout 300;

          access_log /dev/stdout main;
          error_log /dev/stdout warn;

          ssl_certificate /etc/ssl/tls.crt;
          ssl_certificate_key /etc/ssl/tls.key;

          client_header_buffer_size    8k;
          large_client_header_buffers  4 32k;
        
          server_tokens off;
          
          #Reverse Proxy rules to serve the BFF from other container
          
          location ~* ^/internal/metrics {
            deny all;
            return 403;
            server_tokens off;
          }          
          location /ws/ {
            proxy_connect_timeout 1h;
            proxy_send_timeout 1h;
            proxy_read_timeout 1h;
            proxy_buffers 4 64k;
            proxy_buffer_size 32k; 
            proxy_busy_buffers_size 64k;
            proxy_pass http://websocket;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
          }
          location / {
            add_header Strict-Transport-Security "max-age=31536000";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_buffers 4 64k;
            proxy_buffer_size 32k; 
            proxy_busy_buffers_size 64k;

            proxy_pass http://localhost:80;
          }
        }
        
    serviceMonitor:
      enabled: false
      endpoints:
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 80
          scheme: http
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 8090
          scheme: http
    service:
      port_name: https
      port: 443
    autoscaling:
      enabled: false
    vault:
      url: "https://vault_eu_prod.b2b.regn.net"
      VaultSecretPath: ""
      SecretPathProxy: "kv/cha/k8s/data/authoring-auth-proxy/mongo"
      VaultK8sRoleName: ""
      VaultK8sAuthPath: "auth/cha/eks-a"