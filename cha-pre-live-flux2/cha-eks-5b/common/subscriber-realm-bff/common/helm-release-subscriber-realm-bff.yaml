apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: subscriber-realm-bff
spec:
  interval: 5m0s
  chart:
    spec:
      chart: subscriber-realm-bff
      version: "0.1.12"
      sourceRef:
        kind: HelmRepository
        name: helm-charts
        namespace: flux-system
  upgrade:
    remediation:
      remediateLastFailure: true
      strategy: rollback
  values:
    replicaCount: 1
    vault_agent:
      repository: "artifacts.cha.rbxd.ds/base-image/vault"
      tag: "latest"
    consul_template:
      repository: "artifacts.cha.rbxd.ds/base-image/consul-template"
      tag: "alpine"
    authproxy:
      port: 8090
      image:
        repository: artifacts.cha.rbxd.ds/automated/sbcore/sbcore-auth-proxy # {"$imagepolicy": "sbcore-auth-proxy-stable:name"}
        tag: stable-108-1.4.95.1215 # {"$imagepolicy": "flux-system:sbcore-auth-proxy-stable:tag"}
        pullPolicy: IfNotPresent
      appsettings:
        ENVIRONMENT: performance
        Proxy__ForwardToPath: http://localhost:8087
        Proxy__HealthCheckPath: /health
      resources:
        requests:
          memory: "64Mi"
          cpu: "100m"
        limits:
          memory: "128Mi"
          cpu: "100m"
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 8090
        initialDelaySeconds: 30
        periodSeconds: 5
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 8090
        periodSeconds: 30
    nginx:
      port: 8080
      image:
        repository: artifacts.cha.rbxd.ds/base-image/nginx
        tag: alpine3.17
        pullPolicy: IfNotPresent
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 8080
          scheme: HTTPS
        initialDelaySeconds: 30
        periodSeconds: 5
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 8080
          scheme: HTTPS
        periodSeconds: 30
      resources:
        requests:
          memory: "64Mi"
          cpu: "100m"
        limits:
          memory: "64Mi"
          cpu: "100m"
      config: "server {\n  listen 8080 ssl;\n  server_name  localhost;\n  access_log /dev/stdout main;\n  error_log /dev/stdout warn;\n  ssl_certificate /etc/ssl/tls.crt;\n  ssl_certificate_key /etc/ssl/tls.key;\n  client_header_buffer_size    8k;\n  large_client_header_buffers  4 32k;\n  server_tokens off;\n  location ~* ^/internal/metrics {\n      deny all;\n      return 403;\n      server_tokens off;\n  }\n  location / {\n    add_header Strict-Transport-Security \"max-age=31536000\";\n    proxy_set_header Host $http_host;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n\n    proxy_buffers 4 64k;\n    proxy_buffer_size 32k; \n    proxy_busy_buffers_size 64k;\n\n    proxy_pass http://localhost:8090;\n  }\n}"
    service:
      port_name: https
      port: 443
    securityContext:
      privileged: false
    autoscaling:
      enabled: false
    container:
      lifecycle:
        preStop:
          exec:
            command: ["/bin/sh", "-c", "sleep 20"]
    serviceMonitor:
      enabled: true
      endpoints:
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 8090
          scheme: http
    vault:
      url: "https://vault_eu_prod.b2b.regn.net"
      SecretPathProxy: "kv/cha/k8s/data/subscriber-auth-proxy/mongo"
      VaultK8sAuthPath: "auth/cha/eks-b"
