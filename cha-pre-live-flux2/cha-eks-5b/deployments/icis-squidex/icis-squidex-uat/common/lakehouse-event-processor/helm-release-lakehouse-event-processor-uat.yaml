---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: lakehouse-event-processor
  namespace: icis-squidex-uat
spec:
  interval: 5m0s
  chart:
    spec:
      chart: squidex-lakehouse-event-processor
      version: "0.0.2"
      sourceRef:
        kind: HelmRepository
        name: helm-charts
        namespace: flux-system
  values:
    ServiceAccountName: "icis-squidex"
    
    event_processor:
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 80
        initialDelaySeconds: 60
        periodSeconds: 30
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 80
        initialDelaySeconds: 60
        periodSeconds: 30
      config_env:
        LOG_LEVEL: Error
        ELASTIC_APM_ENABLED: true
        ELASTIC_APM_CENTRAL_CONFIG: false
        ELASTIC_APM_TRANSACTION_IGNORE_URLS: /internal/*
        ELASTIC_APM_SERVER_URLS: https://apm.genesis.cha.eu-west-1.dev/
        ELASTIC_APM_TRANSACTION_SAMPLE_RATE: 1
        ELASTIC_APM_CAPTURE_BODY: all
        ELASTIC_APM_ENVIRONMENT: uat

    serviceMonitor:
      enabled: true
      endpoints:
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 80
          scheme: http
    
    autoscaling:
      enabled: false

    vault_secrets:
      VaultK8sAuthPath: "cha/eks-b"
      VaultK8sRoleName: "kv-icis-squidex-read"
      VaultSecretMount: "kv/cha/k8s"


