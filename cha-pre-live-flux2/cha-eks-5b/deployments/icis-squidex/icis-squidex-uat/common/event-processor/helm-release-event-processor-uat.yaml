apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: event-processor
  namespace: icis-squidex-uat
spec:
  interval: 5m0s
  chart:
    spec:
      chart: generic-event-processor-kafka-consumer
      version: "0.13.5"
      sourceRef:
        kind: HelmRepository
        name: helm-charts
        namespace: flux-system
  upgrade:
    remediation:
      remediateLastFailure: true
      strategy: rollback
  values:
    replicaCount: 1
    kafka_consumer:
      image:
        repository: artifacts.cha.rbxd.ds/estream/generic-kafka-consumer
        tag: 3.0.0.385
        pullPolicy: IfNotPresent
      resources:
        limits:
          cpu: 200m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
      securityContext:
        readOnlyRootFilesystem: true
        privileged: false
      config_env:
        KafkaConsumer_AppSettings__Consumer__SecurityProtocol: 3
        KafkaConsumer_AppSettings__Consumer__SaslMechanism: 1
        KafkaConsumer_ElasticApm__ServerUrl: https://apm.genesis.cha.eu-west-1.dev/
        KafkaConsumer_AppSettings__ClusterConfig__SchemaRegistryUrl: "https://psrc-4xrp1.eu-central-1.aws.confluent.cloud"
        KafkaConsumer_AppSettings__Consumer__BrokerUrls: "pkc-l568n.eu-west-1.aws.confluent.cloud:9092"
    event_processor:
      image:
        repository: "artifacts.cha.rbxd.ds/automated/icis-squidex/event-processor" # {"$imagepolicy": "flux-system:icis-squidex-event-processor-uat:name"}
        tag: "uat-36-1.0.0-30-g7aa1666" # {"$imagepolicy": "flux-system:icis-squidex-event-processor-uat:tag"}
        pullPolicy: IfNotPresent
      resources:
        limits:
          cpu: 200m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 80
        initialDelaySeconds: 90
        periodSeconds: 30
      securityContext:
        readOnlyRootFilesystem: true
        privileged: false
      config_env:
        SchemaRegistry__Url: https://psrc-4xrp1.eu-central-1.aws.confluent.cloud/
        ELASTIC_APM_SERVER_URLS: https://apm.genesis.cha.eu-west-1.dev/
        ELASTIC_APM_TRANSACTION_IGNORE_URLS: /internal/*
        SECRET_FILE_PATH: /etc/secrets/.env
    service:
      port: 8080
      type: ClusterIP
    serviceMonitor:
      enabled: true
      endpoints:
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 80
          scheme: http
    autoscaling:
      enabled: false
    # vault_secrets:
    #   VaultSecretPath: "icis-squidex/common"
    #   VaultK8sAuthPath: "cha/eks-b"
    #   VaultK8sRoleName: "kv-icis-squidex-read"
    #   VaultSecretMount: "kv/cha/k8s"
    # vault_secrets_consumer:
    #   VaultK8sAuthPath: "cha/eks-b"
    #   VaultK8sRoleName: "kv-icis-squidex-read"
    #   VaultSecretMount: "kv/cha/k8s"
    vault:
      url: "https://vault_eu_prod.b2b.regn.net"
      VaultK8sAuthPath: "auth/cha/eks-b"
      VaultSecretPath: "kv/cha/k8s/data/icis-squidex/common"
      VaultK8sRoleName: "kv-icis-squidex-read"
      certificate:
        vault.crt: |-
          -----BEGIN CERTIFICATE-----
          MIIEijCCA3KgAwIBAgIQay0iJoZ+c6NJt7cqchus+zANBgkqhkiG9w0BAQsFADBg
          MRMwEQYKCZImiZPyLGQBGRYDbmV0MRQwEgYKCZImiZPyLGQBGRYEcmVnbjETMBEG
          CgmSJomT8ixkARkWA2IyYjEeMBwGA1UEAxMVYjJiLVJCSVFIU1BLSVAwMDJWLUNB
          MB4XDTE3MDgxNzA5MzY1N1oXDTI3MDgxNzA5NDY1N1owYDETMBEGCgmSJomT8ixk
          ARkWA25ldDEUMBIGCgmSJomT8ixkARkWBHJlZ24xEzARBgoJkiaJk/IsZAEZFgNi
          MmIxHjAcBgNVBAMTFWIyYi1SQklRSFNQS0lQMDAyVi1DQTCCASIwDQYJKoZIhvcN
          AQEBBQADggEPADCCAQoCggEBAMv3KNkRI/WzMqcLwkSsKU3vM5coMtDbqdPccdXU
          MufO94gQXzWsLYN4gUVW2BQq2ULolCzwEDuEep61By2uKw4myr9RHENM8zy7cQXs
          VvrkNiE+cyYa2zxxM34ImJDc19vHdBovX0zcY3jT3uqtdJX42Etvh2zJoAi26SDk
          9miXggePd9eoGfnE6MKxTdCtf3s7AHQxR9Y3Rx+uCMKOSWNN+LterAA2n7qMtu6n
          Uo51ZXmCdJYQDgyvVgS2CgUZwfCwBvD3bCeDwM8FLOr/V/5FDDVvIDmREqQN1eeY
          Y2q7UQTujHRFzF18Iw+Thk1eGV/zyNvaXr8ny7o1uOeIg80CAwEAAaOCAT4wggE6
          MBMGCSsGAQQBgjcUAgQGHgQAQwBBMAsGA1UdDwQEAwIBhjAPBgNVHRMBAf8EBTAD
          AQH/MB0GA1UdDgQWBBQjySkPLCVwclOIUQnzz5V3rO+1WzASBgkrBgEEAYI3FQEE
          BQIDBQAFMIGsBgNVHR8EgaQwgaEwgZ6ggZuggZiGSmh0dHA6Ly9yYmlxaHNwa2lw
          MDAzdi5iMmIucmVnbi5uZXQvQ2VydEVucm9sbC9iMmItUkJJUUhTUEtJUDAwMlYt
          Q0EoNSkuY3JshkpodHRwOi8vcmJpcWhzcGtpcDAwNHYuYjJiLnJlZ24ubmV0L0Nl
          cnRFbnJvbGwvYjJiLVJCSVFIU1BLSVAwMDJWLUNBKDUpLmNybDAjBgkrBgEEAYI3
          FQIEFgQU2RDhuv3cL/CQBA4ZVzMUpO+Tqf4wDQYJKoZIhvcNAQELBQADggEBADHm
          Vhw0S0ICMgXQDpXOp8nraCKsm9LpLcmi/SOtR35AgGQmxAxlPebKgIL3vpUOfnec
          10htfOInwmF2dVheluEoFBPSbh0uXm3+Rm2p44/d6HTo5AkTygOQf3Fdu0IFqvBH
          kXBLyQkgVfH2p3OjIfJAV+6seWBI3n+VvBg+YUVYHIqUCHzmxL07ztKuI7f6ZTuO
          8AvcJzMcsjKkGeUNS3lNimEdI339C93BrBDNzPHZe7LOQr7SiFcIU32hIKfLLkWT
          MM+pxYAJe1wZkDN1XvYgQ+R4W9XItalDf4y4ZwQIpYo60jZLS1OJQJngE3Tu6R2K
          gA9dcD2vlZA86EhY8Mg=
          -----END CERTIFICATE-----
