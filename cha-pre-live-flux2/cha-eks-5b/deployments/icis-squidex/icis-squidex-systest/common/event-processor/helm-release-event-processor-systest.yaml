apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: event-processor
  namespace: icis-squidex-systest
spec:
  interval: 5m0s
  chart:
    spec:
      chart: generic-event-processor-kafka-consumer
      version: "0.13.13"
      sourceRef:
        kind: HelmRepository
        name: helm-charts
        namespace: flux-system
  upgrade:
    remediation:
      remediateLastFailure: true
      strategy: rollback
  values:
    replicaCount: 1
    kafka_consumer:
      image:
        repository: artifacts.cha.rbxd.ds/estream/generic-kafka-consumer
        tag: 3.1.0-vso.1.1002
        pullPolicy: IfNotPresent
      resources:
        limits:
          cpu: 200m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
      securityContext:
        readOnlyRootFilesystem: true
        privileged: false
      config_env:
        KafkaConsumer_AppSettings__Consumer__SecurityProtocol: 3
        KafkaConsumer_AppSettings__Consumer__SaslMechanism: 1
        KafkaConsumer_ElasticApm__ServerUrl: https://apm.genesis.cha.eu-west-1.dev/
        KafkaConsumer_AppSettings__ClusterConfig__SchemaRegistryUrl: "https://psrc-4xrp1.eu-central-1.aws.confluent.cloud"
        KafkaConsumer_AppSettings__Consumer__BrokerUrls: "pkc-l568n.eu-west-1.aws.confluent.cloud:9092"
    event_processor:
      image:
        repository: "artifacts.cha.rbxd.ds/automated/icis-squidex/event-processor" # {"$imagepolicy": "flux-system:icis-squidex-event-processor-systest:name"}
        tag: "systest-12-0.1.12-awf-290-env-changes.49-246" # {"$imagepolicy": "flux-system:icis-squidex-event-processor-systest:tag"}
        pullPolicy: IfNotPresent
      resources:
        limits:
          cpu: 200m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 80
        initialDelaySeconds: 90
        periodSeconds: 30
      securityContext:
        readOnlyRootFilesystem: true
        privileged: false
      config_env:
        SchemaRegistry__Url: https://psrc-4xrp1.eu-central-1.aws.confluent.cloud/
        ELASTIC_APM_SERVER_URLS: https://apm.genesis.cha.eu-west-1.dev/
        ELASTIC_APM_TRANSACTION_IGNORE_URLS: /internal/*
        SECRET_FILE_PATH: /etc/secrets/.env
    service:
      port: 8080
      type: ClusterIP
    serviceMonitor:
      enabled: true
      endpoints:
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 80
          scheme: http
    autoscaling:
      enabled: false
    vault_secrets:
      VaultSecretPath: "icis-squidex/common"
      VaultK8sAuthPath: "cha/eks-b"
      VaultK8sRoleName: "kv-icis-squidex-read"
      VaultSecretMount: "kv/cha/k8s"
    vault_secrets_consumer:
      VaultK8sAuthPath: "cha/eks-b"
      VaultK8sRoleName: "kv-icis-squidex-read"
      VaultSecretMount: "kv/cha/k8s"
      
