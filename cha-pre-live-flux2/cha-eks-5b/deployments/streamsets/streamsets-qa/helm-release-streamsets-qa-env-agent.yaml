apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: streamsets-qa-env-agent
  namespace: streamsets-qa
spec:
  interval: 5m0s
  chart:
    spec:
      chart: streamsets-env-agent
      version: 0.0.5
      sourceRef:
        kind: HelmRepository
        name: helm-charts
        namespace: flux-system
  upgrade:
    remediation:
      remediateLastFailure: true
      strategy: rollback
  values:
    serviceAccountName: "streamsets"
    namespace: "streamsets-qa"
    streamsets:
      image:
        repository: "artifacts.cha.rbxd.ds/automated/streamsets" # {"$imagepolicy": "flux-system:streamsets-env:name"}
        tag: "agent-3-0.0.0.3" # {"$imagepolicy": "flux-system:streamsets-env:tag"}
        pullPolicy: Always
      config_env:
        ENVIRONMENT_NAME: streamsets-qa
        ENVIRONMENT_TAGS: k8s-env-tag
        KUBERNETES_NAMESPACE: streamsets-qa
        KUBERNETES_API: https://F22904D41BB107F1E2EC69BA78FA5550.gr7.eu-west-1.eks.amazonaws.com
        CLUSTER_VERSION: cha-eks-5b
    vault_secrets:
      name: streamsets-qa-secrets-env-agent
      VaultK8sRoleName: "kv-streamsets-read"
      VaultK8sAuthPath: "cha/eks-b"
      VaultSecretMount: "kv/cha/k8s"
      VaultSecretPath: "streamsets/qa"
    vault_secrets_streamsets:
      name: streamsets-qa-job-env-agent
      VaultK8sRoleName: "kv-streamsets-read"
      VaultK8sAuthPath: "cha/eks-b"
      VaultSecretMount: "kv/cha/k8s"
      VaultSecretPath: "streamsets/common"
