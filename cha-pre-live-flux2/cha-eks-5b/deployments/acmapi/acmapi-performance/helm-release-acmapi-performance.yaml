apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: access-control-manager-service
spec:
  interval: 5m0s
  chart:
    spec:
      chart: acmapi
      version: "0.1.7"
      sourceRef:
        kind: HelmRepository
        name: helm-charts
        namespace: flux-system
  upgrade:
    remediation:
      remediateLastFailure: true
      strategy: rollback
  releaseName: access-control-manager-service-performance
  values:
    replicaCount: 3
    namespace: "acmapi-performance"
    environment: "performance"
    ServiceAccountName: "acmapi"
    projectName: "access-control-manager-service"
    acmapi:
      port: 80
      image:
        repository: "artifacts.cha.rbxd.ds/automated/acmapi/service" # {"$imagepolicy": "flux-system:acmapi-service-performance:name"}
        tag: "performance-21-2.0.1-github-action-12572" # {"$imagepolicy": "flux-system:acmapi-service-performance:tag"}
        pullPolicy: IfNotPresent
      resources:
        requests:
          memory: "128Mi"
          cpu: "50m"
        limits:
          memory: "256Mi"
          cpu: "250m"
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 80
        initialDelaySeconds: 30
        periodSeconds: 5
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 80
        periodSeconds: 30
      config_env:
        ENVIRONMENT: performance
        ASPNETCORE_ENVIRONMENT: performance
        AWS_BUCKET_NAME: icis-entitlement-admin-performance-lambda-acm
        AWS_CONNECT_WITH_IAM_ROLE: true
        DEV_MODE: false
        ELASTIC_APM_CAPTURE_BODY: all
        ELASTIC_APM_SERVER_URLS: "https://apm.genesis.cha.eu-west-1.dev/"
        ELASTIC_APM_TRANSACTION_IGNORE_URLS: "/internal/*"
        ELASTIC_APM_TRANSACTION_SAMPLE_RATE: .1
        LOG_LEVEL: Debug
        TRACE_ENABLED: true
    nginx:
      port: 8080
      image:
        repository: artifacts.cha.rbxd.ds/base-image/nginx
        tag: alpine
        pullPolicy: IfNotPresent
      resources:
        requests:
          memory: "64Mi"
          cpu: "50m"
        limits:
          memory: "128Mi"
          cpu: "100m"
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 8080
          scheme: HTTPS
        initialDelaySeconds: 30
        periodSeconds: 5
        timeoutSeconds: 2
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 8080
          scheme: HTTPS
        periodSeconds: 30
      config: "server {\n  listen 8080 ssl;\n  server_name  localhost;\n\n  proxy_read_timeout 300;\n  proxy_connect_timeout 300;\n  proxy_send_timeout 300;\n\n  access_log /dev/stdout main;\n  error_log /dev/stdout warn;\n\n  ssl_certificate /etc/ssl/tls.crt;\n  ssl_certificate_key /etc/ssl/tls.key;\n\n  client_header_buffer_size    16k;\n  large_client_header_buffers  4 64k;\n\n  server_tokens off;\n  \n  #Reverse Proxy rules to serve the BFF from other container\n  \n  location ~* ^/internal/metrics {\n    deny all;\n    return 403;\n    server_tokens off;\n  }\n  \n  location / {\n    add_header Strict-Transport-Security \"max-age=31536000\";\n    proxy_set_header Host $http_host;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n\n    proxy_buffers 4 128k;\n    proxy_buffer_size 64k;\n    proxy_busy_buffers_size 128k;\n\n    proxy_pass http://localhost:80;\n  }\n}"
    serviceMonitor:
      enabled: true
      endpoints:
        - interval: 30s
          honorLabels: true
          path: /internal/metrics
          targetPort: 80
          scheme: http
    service:
      port_name: https
      port: 443
    vault_secrets:
      name: acmpapi-vault-secret-performance
      VaultK8sRoleName: "kv-acmapi-read"
      VaultK8sAuthPath: "cha/eks-b"
      VaultSecretMount: "kv/cha/k8s"
      VaultSecretPath: "acmapi/performance"
    autoscaling:
      enabled: false
      minReplicas: 3
      maxReplicas: 6
      targetCPUUtilizationPercentage: 80
    pdb:
      minAvailable: 2
    ingress:
      enabled: true
      className: icis-nginx-ingress
      annotations:
        cert-manager.io/cluster-issuer: vault-issuer
        nginx.ingress.kubernetes.io/backend-protocol: HTTPS
        nginx.ingress.kubernetes.io/ssl-ciphers: "ALL:!aNULL:!EXPORT56:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP"
        nginx.ingress.kubernetes.io/proxy-buffer-size: "32k"
      host:
        name: acm.performance.cha.rbxd.ds
        path: /
        tls: "true"
      tls:
        - hosts:
            - acm.performance.cha.rbxd.ds
          secretName: acm.performance.cha.rbxd.ds
