apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: domain-identity-service
spec:
  releaseName: domain-identity-service-systest
  values:
    replicaCount: 1
    namespace: "didens-systest"
    environment: "systest"
    didens:
      port: 80
      image:
        repository: "artifacts.cha.rbxd.ds/automated/domain-identity/core" # {"$imagepolicy": "flux-system:domain-identity-systest:name"}
        tag: "systest-267-2.0.0-vega-4804-di-checkmarx-cleanup-12701" # {"$imagepolicy": "flux-system:domain-identity-systest:tag"}
        pullPolicy: IfNotPresent
      resources:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "1"
      readinessProbe:
        httpGet:
          path: /internal/health/readiness
          port: 80
        initialDelaySeconds: 30
        periodSeconds: 5
      livenessProbe:
        httpGet:
          path: /internal/health/liveness
          port: 80
        periodSeconds: 30
      config_env:
        ENVIRONMENT: systest
        LOG_LEVEL: Debug
        CORS_ORIGINS_DOMAINS: https://domainidentity.systest.cha.rbxd.ds,https://localhost:7002,http://localhost:3001
        MONGO_DB_CONNECTION_STRING: "mongodb+srv://<username>:<password>@cha-pre-live-ak0n6.mongodb.net/didens-systest?retryWrites=true&w=majority&maxPoolSize=1024"
        FEDERATION_TYPE: "WsFederation"
        WSFEDERATION_WREALM: "https://domainidentity.systest.cha.rbxd.ds/"
        WSFEDERATION_DISPLAYNAME: "CHA"
        WSFEDERATION_ALLOWED_ROLE_GROUP: "ADFS-ICIS-DOMAIN-IDENTITY-PRELIVE"
        OIDC_DISPLAYNAME: "Duende Test"
        OIDC_AUTHORITY: "https://demo.duendesoftware.com/"
        OIDC_CLIENTID: "interactive.confidential"
        OIDC_SECRET: "secret"
        OIDC_ALLOWED_ROLE_GROUP: "RBI-AZ-ICIS-DOMAIN-IDENTITY-PRELIVE"
        TRACE_ENABLED: true
        ELASTIC_APM_TRANSACTION_SAMPLE_RATE: 1
        ELASTIC_APM_CAPTURE_BODY: all
        ENABLE_DUENDE_LICENSE_KEY: false
        SECRET_FILE_PATH: /etc/secrets/.env
        SWAGGER_CONFIGURATION_AUTHORIZATION_URL: "https://domainidentity.systest.cha.rbxd.ds/connect/authorize"
        SWAGGER_CONFIGURATION_TOKEN_URL: "https://domainidentity.systest.cha.rbxd.ds/connect/token"
        SWAGGER_CONFIGURATION_CLIENT_ID: "didens-swagger-api"
        SWAGGER_CONFIGURATION_CLIENT_SECRET: "dFeQxrDiBb1UBoofsd/Ccew38yqN/2LMnVMwDRlhzmg="
        SWAGGER_CONFIGURATION_CLIENT_REDIRECT_URL: "https://domainidentity.systest.cha.rbxd.ds/swagger/oauth2-redirect.html"
        HEALTHCHECK_READINESS: "/internal/health/readiness"
        HEALTHCHECK_LIVENESS: "/internal/health/liveness"
        WSFEDERATION_METADATAADDRESS: "https://adfs.cha.rbxd.ds/federationmetadata/2007-06/federationmetadata.xml"
        ELASTIC_APM_TRANSACTION_IGNORE_URLS: /internal/*
        ELASTIC_APM_SERVER_URLS: https://apm.genesis.cha.eu-west-1.dev/
        AUTHENTICATION_COOKIE_LIFETIME_DAYS: 0.04 # ~1 hour
        AUTHENTICATION_ENABLE_COOKIE_SLIDING_EXPIRATION: true
    ingress:
      enabled: true
      className: icis-nginx-ingress
      annotations:
        cert-manager.io/cluster-issuer: vault-issuer
        nginx.ingress.kubernetes.io/backend-protocol: HTTPS
        nginx.ingress.kubernetes.io/ssl-ciphers: "ALL:!aNULL:!EXPORT56:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP"
        nginx.ingress.kubernetes.io/proxy-buffer-size: "32k"
      host:
        name: domainidentity.systest.cha.rbxd.ds
        paths:
          - /
        tls: "true"
      tls:
        - hosts:
            - domainidentity.systest.cha.rbxd.ds
          secretName: domainidentity.systest.cha.rbxd.ds
    vault_secrets:
      name: domain-identity-vault-secret-service-systest
      VaultSecretPath: "didens/systest"
