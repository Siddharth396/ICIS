apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: {{ .Values.namespace }}
  name: {{ include "supdem-processor.fullname" . }}
  labels:
    app.kubernetes.io/name: {{ include "supdem-processor.name" . }}
    helm.sh/chart: {{ include "supdem-processor.chart" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    require-iam-access: "true"
    require-internet-egress: "true"
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "supdem-processor.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/config: {{ include (print $.Template.BasePath "/application_configmap.yaml") . | sha256sum }}
      labels:
        app.kubernetes.io/name: {{ include "supdem-processor.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      serviceAccountName: {{ .Values.ServiceAccountName }}
      initContainers:

###################################
# Vault init container
###################################
      - name: vault-agent-auth
        image: "{{ .Values.vault_agent.repository }}:{{ .Values.vault_agent.tag }}"
   
        volumeMounts:
          - name: conf-vol
            mountPath: /etc/vault
          - name: vault-token
            mountPath: /home/vault
          - name: vault-cert
            mountPath: /home/vault-cert/vault.crt
            subPath: "vault.crt"
   
        env:
          - name: VAULT_ADDR
            value: {{ .Values.vault.url }}
          - name: VAULT_CACERT
            value: /home/vault-cert/vault.crt
   
        # Run the Vault agent
        args:
          [
            "agent",
            "-config=/etc/vault/vault-agent-config.hcl",
            "-log-level=debug",
          ]

###################################
# Consul Template init container
###################################
      - name: consul-template
        image: "{{ .Values.consul_template.repository }}:{{ .Values.consul_template.tag }}"
        imagePullPolicy: Always
   
        volumeMounts:
          - name: vault-token
            mountPath: /home/vault
          - name: conf-vol
            mountPath: /etc/consul-template
          - name: shared-data
            mountPath: /etc/secrets
          - name: vault-cert
            mountPath: /home/vault-cert/vault.crt
            subPath: "vault.crt"
   
        env:
          - name: HOME
            value: /home/vault
          - name: VAULT_ADDR
            value: {{ .Values.vault.url }}
          - name: VAULT_CACERT
            value: /home/vault-cert/vault.crt
   
        # Consul-Template looks in $HOME/.vault-token, $VAULT_TOKEN, or -vault-token (via CLI)
        args:
          [
            "-config=/etc/consul-template/consul-template-config.hcl",
            "-once",
            #"-log-level=debug",
          ]
      containers:

###################################
# Dotnet Processor Container
###################################     
      - name: supdem-event-processor-{{ .Values.environment }}
        image: "{{ .Values.processor.image.repository }}:{{ .Values.processor.image.tag }}"
        imagePullPolicy: {{ .Values.processor.image.pullPolicy }}
        securityContext:
{{ toYaml .Values.processor.securityContext | indent 12 }}
        ports:
          - name: {{ .Values.app_container.name }}
            containerPort: {{ .Values.processor.port }}
        env:
          {{- range $key, $value := .Values.processor.env_vars }}
             - name: {{ $key }}
               value: {{ $value | quote }}
          {{- end }}

        resources:
{{ toYaml .Values.resources | indent 12 }}
        volumeMounts:
        - name: processor-vol
          mountPath: "/app/conf"
        - name: shared-data
          mountPath: "/app/secrets"
        lifecycle:
{{ toYaml .Values.container.lifecycle | indent 12 }}

###################################
# Dotnet Poller Container
###################################     
      - name: supdem-event-processor-poller-{{ .Values.environment }}
        image: "{{ .Values.poller.image.repository }}:{{ .Values.poller.image.tag }}"
        imagePullPolicy: {{ .Values.poller.image.pullPolicy }}
        securityContext:
{{ toYaml .Values.poller.securityContext | indent 12 }}
        ports:
          - name: {{ .Values.app_container.name }}
            containerPort: {{ .Values.poller.port }}
        env:
          {{- range $key, $value := .Values.poller.env_vars }}
             - name: {{ $key }}
               value: {{ $value | quote }}
          {{- end }}

        resources:
{{ toYaml .Values.resources | indent 12 }}
        volumeMounts:
        - name: poller-vol
          mountPath: "/app/conf"
        - name: shared-data
          mountPath: "/app/secrets"
        lifecycle:
{{ toYaml .Values.container.lifecycle | indent 12 }}

###################################
# Nginx Container
###################################     
      - name: nginx-{{ .Values.environment }}
        image: "{{ .Values.nginx.image.repository }}:{{ .Values.nginx.image.tag }}"
        imagePullPolicy: Always
        securityContext:
          capabilities:
            add:
            - SYS_ADMIN
          privileged: true
        ports:
          - name: nport
            containerPort: 8080
        volumeMounts:
        - name: nginx-vol
          mountPath: "/etc/nginx/conf.d"
        - name: nginx-tmp
          mountPath: "/tmp"
        - name: ssl-cert
          mountPath: /etc/ssl

  

###################################
# Volumes
###################################
      volumes:
      - name: processor-vol
        configMap:
          name: {{ .Values.application_configmap.name }}
          items:
            - key: {{ .Values.environment }}_processor_appsettings.json
              path: appsettings.{{ .Values.environment }}.json

      - name: poller-vol
        configMap:
          name: {{ .Values.application_configmap.name }}
          items:
            - key: {{ .Values.environment }}_poller_appsettings.json
              path: appsettings.{{ .Values.environment }}.json        

      - name: nginx-vol
        configMap:
          name: {{ .Values.application_configmap.name }}
          items:
            - key: nginx_default.conf
              path: default.conf

      - name: conf-vol
        configMap:
          name: {{ .Values.configmap.name }}
          items:
            - key: vault-agent-config.hcl
              path: vault-agent-config.hcl

            - key: consul-template-config.hcl
              path: consul-template-config.hcl

      - name: vault-cert
        secret:
          secretName: {{ .Values.vault.name }}
          items:
            - key: vault.crt
              path: vault.crt

      - name: vault-token
        emptyDir:
          medium: Memory

      - name: shared-data
        emptyDir: {}

      - name: nginx-tmp
        emptyDir: {}
        
      - name: ssl-cert
        secret:
          {{- with (first .Values.ingress.tls) }}          
          secretName: {{ .secretName }}
          {{- end }}
          items:
            - key: tls.crt
              path: tls.crt

            - key: tls.key
              path: tls.key