version: "3"
services:

  mongo:
    image: artifacts.cha.rbxd.ds/mongo:5.0.14
    restart: always
    ports:
      - "27017:27017"
    env_file:
      - ./complete-local-setup/mock/localhost/mongodb/.env
    volumes:
      - ./complete-local-setup/mock/localhost/mongodb/initdb.d/:/docker-entrypoint-initdb.d/

  frontend-authproxy:
    image: artifacts.cha.rbxd.ds/sbcore/sbcore-auth-proxy:latest
    depends_on:
      - mongo
    ports:
      - "8050:8050"
    environment:
      - ENVIRONMENT=local
      - Hosting__DevMode=true
      - Hosting__DevPort=8050
      - Proxy__ForwardToPath=https://localhost:8083
      - Proxy__HealthCheckPath=/v1/version
      - MongoDb__ConnectionString=mongodb://${MONGODB_CONNECTION_STRING}
      - MongoDb__Username=${MONGODB_USERNAME}
      - MongoDb__Password=${MONGODB_PASSWORD}
      - Proxy__ExcludedPathsFromAuthorization=(.(jpe?g|png|gif|bmp|ico|js|css)$$)
      - IdentityServer__Authority=https://domainidentity.integration.cha.rbxd.ds
      - IdentityServer__Issuer=https://domainidentity.integration.cha.rbxd.ds
      - IdentityServer__HealthCheckUrl=https://domainidentity.integration.cha.rbxd.ds/internal/health/liveness
      - CookieInfo__Domain=localhost
      - OidcInfo__ClientId=authproxy
      - OidcInfo__ClientSecret=secret
      - BasePath=
      - Api__SendUserContextInHeader=true
      - LOGIN_PROMPT_ENABLED=true
    command:
      - sh
      - -c
      - |
        apk add socat
        socat TCP-LISTEN:5002,fork TCP:172.17.0.1:5002 &
        socat TCP-LISTEN:27017,fork TCP:172.17.0.1:27017 &
        socat TCP-LISTEN:8083,fork TCP:172.17.0.1:8083 &
        /opt/authproxy/run.sh
        
  appshell:
    container_name: app-shell
    image: artifacts.cha.rbxd.ds/sbcore/sbcore-app:latest
    volumes:
      - ./ci/homepage-app.conf:/etc/nginx/conf.d/homepage-app.conf
      - ./ci/ssl:/etc/ssl
    ports:
      - "8083:8083"

  app-shell-bff:
    image: artifacts.cha.rbxd.ds/sbcore/sbcore-app-mockbff:latest
    ports:
      - "4200:4200"

  feedservice:
    container_name: feed-service
    image: artifacts.cha.rbxd.ds/sbcore/sbcore-mfe-feed-service:latest
    ports:
      - "8090:8090"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8090/api/v1/mfe"]
      interval: 2s
      retries: 5
      start_period: 5s
    environment:
      - PORT=8090
      
  backend-authproxy:
    image: artifacts.cha.rbxd.ds/sbcore/sbcore-auth-proxy:latest
    depends_on:
      - mongo
    ports:
      - "4400:7002"
    environment:
      - ENVIRONMENT=local
      - Hosting__DevMode=true
      - Hosting__DevPort=7002
      - Hosting__EnableSSLInDevMode=true
      - Proxy__ForwardToPath=http://localhost:8005
      - Proxy__HealthCheckPath=/v1/version
      - MongoDb__ConnectionString=mongodb://${MONGODB_CONNECTION_STRING}
      - MongoDb__Username=${MONGODB_USERNAME}
      - MongoDb__Password=${MONGODB_PASSWORD}
      - Proxy__ExcludedPathsFromAuthorization=(/v1(\\.[0-9])?/(version|jsnlog\\.logger))|(/swagger?/*)|health
      - IdentityServer__Authority=https://domainidentity.integration.cha.rbxd.ds
      - IdentityServer__Issuer=https://domainidentity.integration.cha.rbxd.ds
      - IdentityServer__HealthCheckUrl=https://domainidentity.integration.cha.rbxd.ds/internal/health/liveness
      - CookieInfo__Domain=localhost
      - OidcInfo__ClientId=authproxy
      - OidcInfo__ClientSecret=secret
    command:
      - sh
      - -c
      - |
        apk add socat
        socat TCP-LISTEN:5002,fork TCP:172.17.0.1:5002 &
        socat TCP-LISTEN:27017,fork TCP:172.17.0.1:27017 &
        socat TCP-LISTEN:8005,fork TCP:172.17.0.1:8005 &
        /opt/authproxy/run.sh
      
# Add own BFF and its auth proxy here when ready.
