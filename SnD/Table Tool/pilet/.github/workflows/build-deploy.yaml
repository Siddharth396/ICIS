name: Build and Deploy Pipeline
on:
  pull_request:
    branches: [ "main", "**" ]
    types: [opened, reopened]
  push:
    branches: [ "main", "**" ]
    tags: [ "**" ]


jobs:
  determine_version:
    runs-on:
      group: dsg-icis-eks-github-actions-runner
      labels: gha-runner-cha-eks-5b
    container: 
      image: artifacts.cha.rbxd.ds/gittools/gitversion:6.0.2
    outputs:
      semver: ${{ steps.semver.outputs.semver }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine version
        id: semver
        run: |
          git config --global --add safe.directory /__w/dsg-icis-snd-table-pilet/dsg-icis-snd-table-pilet
          chmod +x ./github_scripts/gh_version.sh
          export GITHUB_HEAD_REF=${{ github.ref_name }}
          echo "GITHUB_HEAD_REF ${GITHUB_HEAD_REF}" 
          SEMVER=$(./github_scripts/gh_version.sh)
          echo "sem version is : $SEMVER"
          echo "SEMVER=${SEMVER}" >> ${GITHUB_ENV}
          echo "semver=${SEMVER}" >> ${GITHUB_OUTPUT}
  test:
    runs-on:
      group: dsg-icis-eks-github-actions-runner
      labels: gha-runner-cha-eks-5b
    env:
      SEM_VERSION: ${{ needs.determine_version.outputs.semver }}
    needs: determine_version
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }} # checkout the correct branch name

      - name: Run Tests
        run: |
          sudo apt-get update && sudo apt-get install -y bc curl bash
          chmod +x ./github_scripts/run_unit_tests.sh
          ./github_scripts/run_unit_tests.sh

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: unit-tests-reports
          path: test_reports
          # Use always() to always run this step to publish test results when there are test failures
        if: ${{ always() }}

          
  smoke-test:
    runs-on: ubuntu-latest
    needs: determine_version
    env:
      GH_TOKEN: ${{ secrets.GH_AUTOMATION_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Execute Smoke tests
        run: |
          chmod +x ./github_scripts/gh_smoke_tests.sh
          ./github_scripts/gh_smoke_tests.sh

  build:
    runs-on:
      group: dsg-icis-eks-github-actions-runner
      labels: gha-runner-cha-eks-5b
    needs: [determine_version, test, smoke-test, whitesource-scan, checkmarx-scan ]
    env:
      SEM_VERSION: ${{ needs.determine_version.outputs.semver }}
      DOCKER_REGISTRY_CHA: artifacts.cha.rbxd.ds
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }} # checkout the correct branch name

      - name: Login to Docker Hub Artifacts
        uses: docker/login-action@v3
        with:
          registry: artifacts.cha.rbxd.ds
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build Docker Image
        run: |
          sudo apt-get update && sudo apt-get install -y bc curl bash
          chmod +x ./github_scripts/docker-build.sh
          ./github_scripts/docker-build.sh

  whitesource-scan:
    runs-on:
      group: dsg-icis-eks-github-actions-runner
      labels: gha-runner-cha-eks-5b
    needs: determine_version
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }} # checkout the correct branch name

      - name: Run Whitesource Scan
        env:
          WHITESOURCE_API_KEY: ${{ secrets.WHITESOURCE_APIKEY }}
          WHITESOURCE_USER_KEY: ${{ secrets.WHITESOURCE_USERKEY }}
        run: |
          sudo apt-get update && sudo apt-get install -y bc curl bash
          chmod +x ./github_scripts/whitesource_run.sh
          ./github_scripts/whitesource_run.sh ${WHITESOURCE_API_KEY} ${WHITESOURCE_USER_KEY}

  checkmarx-scan:
    runs-on:
      group: dsg-icis-eks-github-actions-runner
      labels: gha-runner-cha-eks-5b
    env:
      SEM_VERSION: ${{ needs.determine_version.outputs.semver }}
      CHECKMARX_USER: ${{ secrets.CX_USER }}
      CHECKMARX_PASS: ${{ secrets.CHECKMARX_PASSWORD }}
      CHECKMARX_PROJECT_NAME: snd-table-pilet
    
    needs: determine_version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Login to Docker Hub Artifacts
        uses: docker/login-action@v3
        with:
          registry: artifacts.cha.rbxd.ds
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Run Checkmarx scan
        run: |
            sudo apt-get update
            sudo apt-get install ca-certificates curl -y
            
            chmod +x ./github_scripts/checkmarx_run.sh

            export CHECKMARX_USER="${{ secrets.CX_USER }}"
            export CHECKMARX_PASSWORD="${{ secrets.CHECKMARX_PASSWORD }}"
            export CHECKMARX_PROJECT_NAME=$CHECKMARX_PROJECT_NAME
            ./github_scripts/checkmarx_run.sh | tee checkmarx.result
            if ! grep -q "High severity results: 0" checkmarx.result || ! grep -q "Medium severity results: 0" checkmarx.result; then
                echo "There are high or medium severity issues."
                exit 1
            else
                echo "No high or medium severity issues found."
                exit 0
            fi

  # ========================================================================================== #
  # systest #
  # ========================================================================================== #
  systest-prep:
    runs-on: ubuntu-latest
    #  this should include: , run-e2e-tests
    needs: [determine_version, checkmarx-scan, whitesource-scan, build, test]
    steps:
      - name: Prep
        run: |
          echo "Preped"

  authoring-systest-deploy:
    runs-on: ubuntu-latest
    environment: systest-authoring
    needs: [determine_version, systest-prep]
    env:
      IMAGE_TYPE: authoring
      SEM_VERSION: ${{needs.determine_version.outputs.semver }}
      ENVIRONMENT: systest
      ASSETID: snd-table
      DEPLOYMENT_REPO: LexisNexis-RBA/dsg-icis-common-mfe-deployment-pre-live
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      PILET_TYPE: -authoring
      FEED_SERVICE_URL: ${{secrets.AUTHORING_FEEDSERVICE_SYSTEST}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deployment to systest
        run: |
          chmod +x ./github_scripts/gh_deployer.sh
          ./github_scripts/gh_deployer.sh

  subscriber-systest-deploy:
    runs-on: ubuntu-latest
    environment: systest-subscriber
    needs: [determine_version, systest-prep]
    env:
      IMAGE_TYPE: subscriber
      SEM_VERSION: ${{ needs.determine_version.outputs.semver }}
      ENVIRONMENT: systest
      ASSETID: snd-table
      DEPLOYMENT_REPO: LexisNexis-RBA/dsg-icis-common-mfe-deployment-pre-live
      FEED_SERVICE_URL: ${{secrets.FEEDSERVICE_SYSTEST}}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deployment to systest
        run: |
          chmod +x ./github_scripts/gh_deployer.sh
          ./github_scripts/gh_deployer.sh


  # ========================================================================================== #
  # systest end #
  # ========================================================================================== #

  
  # ========================================================================================== #
  # staging #
  # ========================================================================================== #
  staging-prep:
    runs-on: ubuntu-latest
    #  this should include: , run-e2e-tests
    needs: [determine_version, checkmarx-scan, whitesource-scan, build, test]
    steps:
      - name: Prep
        run: |
          echo "Preped"

  authoring-staging-deploy:
    runs-on: ubuntu-latest
    environment: staging-authoring
    needs: [determine_version, staging-prep]
    env:
      IMAGE_TYPE: authoring
      SEM_VERSION: ${{needs.determine_version.outputs.semver }}
      ENVIRONMENT: staging
      ASSETID: snd-table
      DEPLOYMENT_REPO: LexisNexis-RBA/dsg-icis-common-mfe-deployment-pre-live
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      PILET_TYPE: -authoring
      FEED_SERVICE_URL: ${{secrets.AUTHORING_FEEDSERVICE_STAGING}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deployment to staging
        run: |
          chmod +x ./github_scripts/gh_deployer.sh
          ./github_scripts/gh_deployer.sh

  subscriber-staging-deploy:
    runs-on: ubuntu-latest
    environment: staging-subscriber
    needs: [determine_version, staging-prep]
    env:
      IMAGE_TYPE: subscriber
      SEM_VERSION: ${{ needs.determine_version.outputs.semver }}
      ENVIRONMENT: staging
      ASSETID: snd-table
      DEPLOYMENT_REPO: LexisNexis-RBA/dsg-icis-common-mfe-deployment-pre-live
      FEED_SERVICE_URL: ${{secrets.FEEDSERVICE_STAGING}}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deployment to staging
        run: |
          chmod +x ./github_scripts/gh_deployer.sh
          ./github_scripts/gh_deployer.sh


  # ========================================================================================== #
  # staging end #
  # ========================================================================================== #

  
  # ========================================================================================== #
  # performance #
  # ========================================================================================== #
  performance-prep:
    runs-on: ubuntu-latest
    #  this should include: , run-e2e-tests
    needs: [determine_version, checkmarx-scan, whitesource-scan, build, test]
    steps:
      - name: Prep
        run: |
          echo "Preped"

  authoring-performance-deploy:
    runs-on: ubuntu-latest
    environment: performance-authoring
    needs: [determine_version, performance-prep]
    env:
      IMAGE_TYPE: authoring
      SEM_VERSION: ${{needs.determine_version.outputs.semver }}
      ENVIRONMENT: performance
      ASSETID: snd-table
      DEPLOYMENT_REPO: LexisNexis-RBA/dsg-icis-common-mfe-deployment-pre-live
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      PILET_TYPE: -authoring
      FEED_SERVICE_URL: ${{secrets.AUTHORING_FEEDSERVICE_PERFORMANCE}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deployment to performance
        run: |
          chmod +x ./github_scripts/gh_deployer.sh
          ./github_scripts/gh_deployer.sh

  subscriber-performance-deploy:
    runs-on: ubuntu-latest
    environment: performance-subscriber
    needs: [determine_version, performance-prep]
    env:
      IMAGE_TYPE: subscriber
      SEM_VERSION: ${{ needs.determine_version.outputs.semver }}
      ENVIRONMENT: performance
      ASSETID: snd-table
      DEPLOYMENT_REPO: LexisNexis-RBA/dsg-icis-common-mfe-deployment-pre-live
      FEED_SERVICE_URL: ${{secrets.FEEDSERVICE_PERFORMANCE}}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deployment to performance
        run: |
          chmod +x ./github_scripts/gh_deployer.sh
          ./github_scripts/gh_deployer.sh


  # ========================================================================================== #
  # performance end #
  # ========================================================================================== #

  # ========================================================================================== #
  # ========================================================================================== #
  ## To deploy to production environment, you need to crate a tag.....
  # ========================================================================================== #
  # ========================================================================================== #
  
  
  # ========================================================================================== #
  # production #
  # ========================================================================================== #
  production-prep:
    runs-on: ubuntu-latest
    #  this should include: , run-e2e-tests
    needs: [determine_version, checkmarx-scan, whitesource-scan, build, test]
    steps:
      - name: Prep
        run: |
          echo "Preped"

  authoring-production-deploy:
    if: ${{ startsWith(github.ref, 'refs/tags/')}}
    runs-on: ubuntu-latest
    environment: production-authoring
    needs: [determine_version, production-prep]
    env:
      IMAGE_TYPE: authoring
      SEM_VERSION: ${{needs.determine_version.outputs.semver }}
      ASSETID: snd-table
      ENVIRONMENT: production
      DEPLOYMENT_REPO: LexisNexis-RBA/dsg-icis-common-mfe-deployment-live
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      PILET_TYPE: -authoring
      FEED_SERVICE_URL: ${{secrets.AUTHORING_FEEDSERVICE_PROD}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deployment to production
        run: |
          chmod +x ./github_scripts/gh_deployer.sh
          ./github_scripts/gh_deployer.sh

  subscriber-production-deploy:
    if: ${{ startsWith(github.ref, 'refs/tags/')}}
    runs-on: ubuntu-latest
    environment: production-subscriber
    needs: [determine_version, production-prep]
    env:
      IMAGE_TYPE: subscriber
      SEM_VERSION: ${{ needs.determine_version.outputs.semver }}
      ASSETID: snd-table
      ENVIRONMENT: production
      DEPLOYMENT_REPO: LexisNexis-RBA/dsg-icis-common-mfe-deployment-live
      FEED_SERVICE_URL: ${{secrets.FEEDSERVICE_PROD}}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deployment to production
        run: |
          chmod +x ./github_scripts/gh_deployer.sh
          ./github_scripts/gh_deployer.sh

  # ========================================================================================== #
  # production end #
  # ========================================================================================== #
